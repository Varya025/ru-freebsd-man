.\" Copyright (c) 2008 The NetBSD Foundation, Inc.
.\" All rights reserved.
.\"
.\" Распространение и использование в исходной и двоичной формах, с или без
.\" изменения разрешены при соблюдении следующих условий
.\" которые встретились:
.\" 1. При повторном распространении исходного кода необходимо сохранять вышеуказанные авторские права.
.\" обратите внимание на этот список условий и следующий отказ от ответственности.
.\" 2. При распространении в двоичной форме необходимо воспроизводить вышеуказанные авторские права.
.\" обратите внимание, этот список условий и следующий отказ от ответственности в
.\" документация и/или другие материалы, прилагаемые к дистрибутиву.
.\"
.» ДАННОЕ ПРОГРАММНОЕ ОБЕСПЕЧЕНИЕ ПРЕДОСТАВЛЕНО NETBSD FOUNDATION, INC. И
.» УЧАСТНИКИ «КАК ЕСТЬ» И ЛЮБЫЕ ЯВНЫЕ ИЛИ ПОДРАЗУМЕВАЕМЫЕ ГАРАНТИИ,
.» ВКЛЮЧАЯ, НО НЕ ОГРАНИЧИВАЯСЬ, ПОДРАЗУМЕВАЕМЫЕ ГАРАНТИИ
.» ТОВАРНАЯ ПРИГОДНОСТЬ И ПРИГОДНОСТЬ ДЛЯ ОПРЕДЕЛЕННОЙ ЦЕЛИ ОТКАЗЫВАЕТСЯ.
.» НИ ПРИ КАКИХ ОБСТОЯТЕЛЬСТВАХ ФОНД ИЛИ ВКЛАДЧИКИ НЕ НЕСУТ ОТВЕТСТВЕННОСТИ ЗА ЛЮБЫЕ
.» ПРЯМОЙ, КОСВЕННЫЙ, СЛУЧАЙНЫЙ, ОСОБЫЙ, ПРИМЕРНЫЙ ИЛИ КОСВЕННЫЙ
.» УБЫТКИ (ВКЛЮЧАЯ, НО НЕ ОГРАНИЧИВАЯСЬ, ПРИОБРЕТЕНИЕ ЗАМЕНЫ
.» ТОВАРОВ ИЛИ УСЛУГ; ПОТЕРИ ИСПОЛЬЗОВАНИЯ, ДАННЫХ ИЛИ ПРИБЫЛИ; ИЛИ БИЗНЕСА
.\" ПЕРЕРЫВ) ОДНАКО ВЫЗВАН И ПО ЛЮБОЙ ТЕОРИИ ОТВЕТСТВЕННОСТИ, БОЛЬШЕ
.» ПО КОНТРАКТУ, СТРОГОВОЙ ОТВЕТСТВЕННОСТИ ИЛИ ПРАВИЛАМ (ВКЛЮЧАЯ НЕБРЕЖНОСТЬ ИЛИ
.\" ИНАЧЕ), ВОЗНИКАЮЩИХ ЛЮБЫМ СПОСОБОМ ИСПОЛЬЗОВАНИЯ ЭТОГО ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ, ДАЖЕ
.» ЕСЛИ ПРЕДУПРЕЖДЕНО О ВОЗМОЖНОСТИ ТАКОГО УЩЕРБА.
.Dd 21 июня 2020 г.
Dt ATF-CHECK 1
.Os
.Sh NAME
.Nm atf-check
.Nd executes a command and analyzes its results
.Sh SYNOPSIS
.Nm
.Op Fl s Ar qual:value
.Op Fl o Ar action:arg ...
.Op Fl e Ar action:arg ...
.Op Fl x
.Ar command
.Sh DESCRIPTION
.Nm
выполняет заданную команду и анализирует ее результаты, в том числе
код выхода, stdout и stderr.
.Pp
.Bf Em
Тестовые случаи должны использовать
.Xr atf-sh 3 Ns ' Ns s
.Nm atf_check
встроенную функцию вместо прямого вызова этой утилиты.
.Ef
.Pp
В первой форме конспекта
.Nm
выполнит предоставленную команду и применит указанные проверки
по аргументам.
По умолчанию он будет действовать так, как если бы он был запущен с помощью
.Fl s
.Ar exit:0
.Fl o
.Ar empty
.Fl e
.Ar empty .
Допускаются множественные проверки для одного и того же выходного канала и, если указано,
их результаты будут объединены как логические и (это означает, что выходные данные должны
соответствовать всем предоставленным проверкам).
.Pp
Во второй форме конспекта
.Nm
распечатает информацию обо всех поддерживаемых опциях и их назначении.
.Pp
Доступны следующие варианты:
.Bl -tag  -width XqualXvalueXX
.It Fl s Ar qual:value
Анализирует статус завершения.
Должно быть одно из:
.Bl -tag -width signal:<value> -compact
.It Ar exit:<value>
проверяет, что программа завершилась корректно и что ее статус выхода равен
.Va value .
Код выхода можно вообще опустить, и в этом случае любой чистый выход будет
принял.
.It Ar ignore
игнорирует выходную проверку.
.It Ar signal:<value>
проверяет, что программа завершилась по сигналу и что сигнал, который
прекращено, это
.Va value .
Сигнал может быть указан как в виде числа, так и в виде имени, а также
можно вообще опустить, и в этом случае принимается любой сигнал.
.El
.Pp
Большинство из этих шашек могут иметь префикс
.Sq not-
строка, которая эффективно отменяет проверку.
.It Fl o Ar action:arg
Анализирует стандартный вывод.
Должно быть одно из:
.Bl -tag -width inline:<value> -compact
.It Ar empty
проверяет, что стандартный вывод пуст
.It Ar ignore
игнорирует стандартный вывод
.It Ar file:<path>
сравнивает стандартный вывод с заданным файлом
.It Ar inline:<value>
сравнивает стандартный вывод со встроенным значением
.It Ar match:<regexp>
ищет регулярное выражение в стандартном выводе
.It Ar save:<path>
сохраняет стандартный вывод в заданный файл
.El
.Pp
Большинство из этих шашек могут иметь префикс
.Sq not-
строка, которая эффективно отменяет проверку.
.It Fl e Ar action:arg
Анализирует стандартную ошибку (синтаксис идентичен приведенному выше)
.It Fl x
Выполняет
.Ar command
как командную строку оболочки, выполняя ее с помощью системной оболочки, определенной
.Va ATF_SHELL .
Вам следует избегать использования этого флага, если это вообще возможно, чтобы предотвратить цитирование оболочки
проблемы.
.It Fl r Ar timeout[:interval]
Повторяет неудачные проверки до тех пор, пока
.Ar timeout
(в секундах) истекает.
Если не указано, по умолчанию
.Ar interval
(в миллисекундах) составляет 50 мс.
Это можно использовать для ожидания ожидаемого обновления содержимого файла.
.El
.Sh ENVIRONMENT
.Bl -tag -width ATFXSHELLXX -compact
.It Va ATF_SHELL
Путь к системной оболочке, который будет использоваться при
.Fl x
предназначен для запуска команд.
.El
.Sh EXIT STATUS
.Nm
выходит из 0 в случае успеха и другого (неуказанного) значения в случае неудачи.
.Sh EXAMPLES
Ниже приведены примеры вызовов из тестового примера.
Обратите внимание, что мы используем
.Nm atf_check
функция, предоставляемая
.Xr atf-sh 3
вместо выполнения
.Nm
напрямую:
.Bd -literal -offset indent
# Exit code 0, nothing on stdout/stderr
atf_check 'true'

# Typical usage if failure is expected
atf_check -s not-exit:0 'false'

# Checking stdout/stderr
echo foobar >expout
atf_check -o file:expout -e inline:"xx\etyy\en" \e
    'echo foobar ; printf "xx\etyy\en" >&2'

# Checking for a crash
atf_check -s signal:sigsegv my_program

# Combined checks
atf_check -o match:foo -o not-match:bar echo foo baz

# Wait 5 seconds for a line to show up in a file
( sleep 2 ; echo "testing 123" > $test_path ) &
atf-check -o ignore -e ignore -s exit:0 -r 5 \e
    grep "testing 123" $test_path
.Ed
.Sh SEE ALSO
.Xr atf-sh 1
